"""\n區間震盪策略測試腳本\n\n支持兩種止損止盈模式:\n1. 固定百分比止損\n2. ATR動態止損\n"""\n\nimport sys\nimport pandas as pd\nimport numpy as np\nfrom datetime import datetime, timedelta\nimport requests\nimport time\n\n# Import strategy\nsys.path.append('.')\nfrom core.range_bound_strategy import RangeBoundStrategy\nfrom core.backtest_range_bound import BacktestRangeBound\n\n\ndef fetch_binance_data(symbol: str = 'BTCUSDT', interval: str = '15m', days: int = 30):\n    \"\"\"\n    從 Binance 獲取數據\n    \"\"\"\n    print(f\"Fetching {symbol} {interval} data for last {days} days...\")\n    \n    end_time = int(datetime.now().timestamp() * 1000)\n    start_time = int((datetime.now() - timedelta(days=days)).timestamp() * 1000)\n    \n    url = 'https://api.binance.com/api/v3/klines'\n    \n    all_data = []\n    current_start = start_time\n    \n    while current_start < end_time:\n        params = {\n            'symbol': symbol,\n            'interval': interval,\n            'startTime': current_start,\n            'limit': 1000\n        }\n        \n        response = requests.get(url, params=params)\n        data = response.json()\n        \n        if not data:\n            break\n        \n        all_data.extend(data)\n        current_start = data[-1][0] + 1  # Next batch starts after last timestamp\n        \n        if len(data) < 1000:\n            break\n        \n        time.sleep(0.1)  # Rate limiting\n    \n    # Convert to DataFrame\n    df = pd.DataFrame(all_data, columns=[\n        'open_time', 'open', 'high', 'low', 'close', 'volume',\n        'close_time', 'quote_volume', 'trades', 'taker_buy_base',\n        'taker_buy_quote', 'ignore'\n    ])\n    \n    # Convert types\n    df['open_time'] = pd.to_datetime(df['open_time'], unit='ms')\n    for col in ['open', 'high', 'low', 'close', 'volume']:\n        df[col] = df[col].astype(float)\n    \n    print(f\"Fetched {len(df)} candles\")\n    return df\n\n\ndef run_backtest(use_atr_stops: bool = True, atr_multiplier: float = 2.0, \n                 fixed_stop_pct: float = 0.02, target_rr: float = 2.0):\n    \"\"\"\n    執行回測\n    \n    Args:\n        use_atr_stops: 是否使用ATR止損 (否則使用固定百分比)\n        atr_multiplier: ATR倍數 (僅當 use_atr_stops=True 時有效)\n        fixed_stop_pct: 固定止損百分比 (0.02 = 2%)\n        target_rr: 風報比 (2.0 = 1:2)\n    \"\"\"\n    # 獲取數據\n    df = fetch_binance_data('BTCUSDT', '15m', days=30)\n    \n    # 初始化策略\n    strategy = RangeBoundStrategy(\n        adx_threshold=25,\n        rsi_oversold=30,\n        rsi_overbought=70,\n        volume_threshold=0.8,\n        use_atr_stops=use_atr_stops,\n        atr_multiplier=atr_multiplier,\n        fixed_stop_pct=fixed_stop_pct,\n        target_rr=target_rr\n    )\n    \n    # 執行回測\n    backtester = BacktestRangeBound(\n        initial_capital=10000.0,\n        leverage=1.0,\n        fee_rate=0.0006\n    )\n    \n    print(\"\\n" + \"=\"*50)\n    if use_atr_stops:\n        print(f\"Running backtest with ATR stops (ATR x{atr_multiplier})\")\n    else:\n        print(f\"Running backtest with Fixed stops ({fixed_stop_pct*100}%)\")\n    print(f\"Target R:R = 1:{target_rr}\")\n    print(\"=\"*50 + \"\\n\")\n    \n    results = backtester.run(df, strategy)\n    \n    # 顯示結果\n    print(\"\\n回測結果:\")\n    print(\"-\" * 50)\n    \n    stats = results['stats']\n    print(f\"  初始資金: ${backtester.initial_capital:,.2f}\")\n    print(f\"  最終資金: ${stats['final_balance']:,.2f}\")\n    print(f\"  總損益: ${stats['total_return']:,.2f}\")\n    print(f\"  報酬率: {stats['return_pct']:.2f}%\")\n    print()\n    print(f\"  交易次數: {stats['total_trades']}\")\n    print(f\"  勝率: {stats['win_rate']:.1f}%\")\n    print(f\"  平均獲利: ${stats['avg_profit']:.2f}\")\n    print(f\"  平均虧損: ${stats['avg_loss']:.2f}\")\n    print(f\"  盈虧比: {stats['profit_factor']:.2f}\")\n    print(f\"  最大回撒: {stats['max_drawdown']:.2f}%\")\n    print(\"-\" * 50)\n    \n    # 顯示交易詳情\n    trades_df = results['trades']\n    if not trades_df.empty:\n        print(\"\\n近期交易記錄 (最後5筆):\")\n        print(trades_df[['time', 'type', 'price', 'reason']].tail(10).to_string(index=False))\n    \n    # 導出 CSV\n    timestamp = datetime.now().strftime(\"%Y%m%d_%H%M%S\")\n    stop_type = \"ATR\" if use_atr_stops else \"FIXED\"\n    filename = f\"BTCUSDT_backtest_{stop_type}_{timestamp}.csv\"\n    trades_df.to_csv(filename, index=False)\n    print(f\"\\n交易記錄已儲存至: {filename}\")\n    \n    return results\n\n\nif __name__ == \"__main__\":\n    print(\"\\n區間震盪策略 (Strategy C) 回測\\n\")\n    \n    # 測試 1: ATR 止損\n    print(\"\\n[Test 1] ATR Stop Loss\")\n    results_atr = run_backtest(\n        use_atr_stops=True,\n        atr_multiplier=2.0,\n        target_rr=2.0\n    )\n    \n    # 測試 2: 固定百分比止損\n    print(\"\\n\\n[Test 2] Fixed Percentage Stop Loss\")\n    results_fixed = run_backtest(\n        use_atr_stops=False,\n        fixed_stop_pct=0.02,  # 2%\n        target_rr=2.0\n    )\n    \n    # 比較\n    print(\"\\n\\n\" + \"=\"*50)\n    print(\"策略比較\")\n    print(\"=\"*50)\n    print(f\"ATR 止損: 報酬率 {results_atr['stats']['return_pct']:.2f}%, 勝率 {results_atr['stats']['win_rate']:.1f}%, 交易 {results_atr['stats']['total_trades']} 次\")\n    print(f\"Fixed 止損: 報酬率 {results_fixed['stats']['return_pct']:.2f}%, 勝率 {results_fixed['stats']['win_rate']:.1f}%, 交易 {results_fixed['stats']['total_trades']} 次\")\n    \n    if results_atr['stats']['return_pct'] > results_fixed['stats']['return_pct']:\n        print(\"\\n建議: 使用 ATR 止損模式\")\n    else:\n        print(\"\\n建議: 使用固定百分比止損模式\")\n